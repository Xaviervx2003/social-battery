import pandas as pd
import requests
import time
import re
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

print("‚öñÔ∏è INICIANDO OPERA√á√ÉO DAVI E GOLIAS: Cruzamento de Porte Tribut√°rio vs. Faturamento...")

try:
    # 1. Carrega os donos do dinheiro
    df_dinheiro = pd.read_csv("base_fiscalizacao_am.csv")
    
    # Agrupa o total ganho por CNPJ
    df_dinheiro['Valor_Numerico'] = df_dinheiro['Valor_Total_Item'].astype(str).str.replace('R$ ', '').str.replace('.', '').str.replace(',', '.').astype(float)
    df_agrupado = df_dinheiro.groupby('CNPJ_Vencedor')['Valor_Numerico'].sum().reset_index()

    cnpjs_unicos = df_agrupado['CNPJ_Vencedor'].unique()
    total = len(cnpjs_unicos)
    
    dados_empresas = []

    # 2. Bate na Receita Federal para descobrir o Porte (ME, EPP, DEMAIS)
    for index, cnpj_original in enumerate(cnpjs_unicos, start=1):
        cnpj_limpo = re.sub(r'[^0-9]', '', str(cnpj_original))
        valor_recebido = df_agrupado[df_agrupado['CNPJ_Vencedor'] == cnpj_original]['Valor_Numerico'].values[0]
        
        print(f"[{index}/{total}] Rastreando o porte tribut√°rio do CNPJ {cnpj_original}...", end=" ")

        url_api = f"https://brasilapi.com.br/api/cnpj/v1/{cnpj_limpo}"
        
        for tentativa in range(3):
            try:
                resposta = requests.get(url_api, verify=False, timeout=10)
                if resposta.status_code == 200:
                    dados = resposta.json()
                    porte = str(dados.get('porte', 'N√ÉO INFORMADO')).upper()
                    
                    # 3. O MOTOR DE AUDITORIA TRIBUT√ÅRIA
                    risco = "‚úÖ Normal"
                    
                    # Se for ME (Teto R$ 360 mil) mas ganhou mais de R$ 1 Milh√£o
                    if "MICRO EMPRESA" in porte and valor_recebido > 1000000:
                        risco = "üö® ALERTA CR√çTICO: Microempresa (ME) recebendo contratos milion√°rios!"
                    
                    # Se for EPP (Teto R$ 4.8 Milh√µes) mas ganhou mais de R$ 6 Milh√µes
                    elif "PEQUENO PORTE" in porte and valor_recebido > 6000000:
                        risco = "‚ö†Ô∏è ALERTA ALTO: EPP estourando o teto do Simples Nacional em licita√ß√£o!"

                    # S√≥ salva se tiver erro grave
                    if "Normal" not in risco:
                        dados_empresas.append({
                            'CNPJ_Suspeito': cnpj_original,
                            'Razao_Social': dados.get('razao_social', 'N/A'),
                            'Porte_Receita_Federal': porte,
                            'Total_Recebido_do_Estado': f"R$ {valor_recebido:,.2f}",
                            'Diagnostico_Tributario': risco
                        })
                    
                    print(f"Porte: {porte}")
                    break
                elif resposta.status_code == 429:
                    time.sleep(5)
            except:
                pass
        time.sleep(1) # Pausa amig√°vel para n√£o derrubar a API

    # 4. Imprime o Relat√≥rio
    df_alertas = pd.DataFrame(dados_empresas)
    
    print("\n" + "="*90)
    print("üö® MALHA FINA TRIBUT√ÅRIA: EMPRESAS FATURANDO ACIMA DO ENQUADRAMENTO LEGAL üö®")
    print("="*90)

    if df_alertas.empty:
        print("‚úÖ Resultado limpo! Nenhuma ME ou EPP estourou os limites com esses contratos.")
    else:
        pd.set_option('display.max_colwidth', None)
        print(df_alertas.sort_values(by='Total_Recebido_do_Estado', ascending=False).to_string(index=False))
        df_alertas.to_csv("ALERTA_TRIBUTARIO_AM.csv", index=False, encoding='utf-8-sig', sep=';')
        print(f"\nüíæ Dossi√™ tribut√°rio salvo como 'ALERTA_TRIBUTARIO_AM.csv'!")

except Exception as e:
    print(f"‚ùå Erro na opera√ß√£o: {e}")